name: AtlasML - Deploy to Test 1

on:
  workflow_dispatch:
    inputs:
      image-tag:
        type: string
        description: 'Image tag to deploy (default: pr-<number> if PR exists, latest for default branch)'
      deploy-atlasml:
        type: boolean
        default: true
        description: (Re-)deploys AtlasML.

jobs:
  provision-env:
    runs-on: ubuntu-latest
    environment: 'Atlas - Test 1'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Traefik on remote host
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ vars.VM_HOST }}
          username: ${{ vars.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          proxy_host: ${{ vars.DEPLOYMENT_GATEWAY_HOST }}
          proxy_username: ${{ vars.DEPLOYMENT_GATEWAY_USER }}
          proxy_key: ${{ secrets.DEPLOYMENT_GATEWAY_SSH_KEY }}
          proxy_port: ${{ vars.DEPLOYMENT_GATEWAY_PORT }}
          script: |
            sudo mkdir -p /opt/atlasml/traefik
            sudo touch /opt/atlasml/traefik/acme.json
            sudo chmod 600 /opt/atlasml/traefik/acme.json
            sudo chown -R $USER:$USER /opt/atlasml/traefik

      - name: Copy Traefik config to remote host
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ vars.VM_HOST }}
          username: ${{ vars.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          proxy_host: ${{ vars.DEPLOYMENT_GATEWAY_HOST }}
          proxy_username: ${{ vars.DEPLOYMENT_GATEWAY_USER }}
          proxy_key: ${{ secrets.DEPLOYMENT_GATEWAY_SSH_KEY }}
          proxy_port: ${{ vars.DEPLOYMENT_GATEWAY_PORT }}
          source: "atlas/traefik/traefik.yml,atlas/traefik/config.yml"
          target: /opt/atlasml/traefik/
          strip_components: 2

  deploy-atlasml:
    needs: provision-env
    if: ${{ inputs.deploy-atlasml }}
    uses: ls1intum/.github/.github/workflows/deploy-docker-compose.yml@main
    with:
      environment: 'Atlas - Test 1'
      docker-compose-file: './atlas/docker-compose.prod.yml'
      main-image-name: ls1intum/edutelligence/atlasml
      image-tag: ${{ inputs.image-tag }}
      deployment-base-path: '/opt/atlasml'
    secrets: inherit
